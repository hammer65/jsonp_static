<!DOCTYPE html>
<html>
<head>
  <title></title>
  <title>My Blog</title>

  <!--
  Style includes just static styles not state styles
  -->
  <style is="custom-style">
   paper-drawer-panel {
     --paper-drawer-panel-left-drawer-container: {
         background-color: #1E1E33; 
         padding-right:2px;
      };
   }
   #post-header{
     --paper-toolbar-background:#CCCCC4;
     --paper-toolbar-color: #000;
     --paper-toolbar-height:36px;
   }

   #content-header{
     --paper-toolbar-background:#FFF;
     --paper-toolbar-color: #595959;
   }

   #new-post{
      cursor:pointer;
   }

   .hidden{
      display:none;
   }

   .dialog{
      width:650px;
   }

   .content{
     height:95%;
     overflow:auto;
   }
  </style>

  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="components.html">
</head>
<body>
  <div id="app"></div>
  <sql-storage id="storage" database="app-storage" />


  <script type="text/javascript" src="bower_components/react/react.js"></script>
  <script type="text/javascript" src="bower_components/react/react-dom.js"></script>
  <script type="text/javascript" src="bower_components/babel/browser.min.js"></script>
  <script type="text/javascript" src="bower_components/flux/dist/Flux.min.js"></script>
  <script type="text/javascript" src="bower_components/react-router/dist/ReactRouter.min.js"></script>

  <script type="text/babel">
    var l = false;
    var Dispatcher = new Flux.Dispatcher();
    Dispatcher.register(function(payload){
      
      console.log('action is',payload.actionType);
      switch(payload.actionType){
        case 'a-show-post':
          Store.getPost(payload.postId);
          break;
        case 'a-post-all':
          Store.getAllPosts();
          l = true;
          break;
        case 'a-new-post':
          Store.create(payload.postData);
          break;
        case 'a-get-post-comments':
          Store.getCommentsByPostId(payload.postId);
          break;
        case 'a-create-comment':
          Store.createComment(payload.postData);
          break;
      }
    });
    var Store = document.querySelector('#storage');

    var Application = React.createClass({
      getInitialState: function(){
        return {
          Dialog:{
            showDialog:false,
            dialogType:null
          },
          Post:{
            postId:null,
            selectedPost:null,
            posts:[]
          }
        }
      },
      componentDidMount: function(){
        Store.addEventListener('change',this.handleChange);
        Dispatcher.dispatch({
          actionType: 'a-post-all'
        });
      },
      handleChange:function(e){
        var payload = e.detail;
        switch(payload.type){
          case 'post-get':
            this.state.Post.selectedPost = payload.data;
            this.setState(this.state);
            Dispatcher.dispatch(
             {actionType: 'a-get-post-comments',postId:payload.data.id}
            );
            break;
          case 'post-all':
            this.state.Post.postId = null;
            this.state.Post.selectedPost = null;
            this.state.Post.posts = payload.data;
            this.setState(this.state);
            break;
          case 'post-create':
            Dispatcher.dispatch({actionType: 'get-all-posts'});
            Dispatcher.dispatch({actionType: 'show-post',postId:payload.data});
            this.setState(this.state);
        }
      },
      newPost: function(){
          this.state.Dialog.showDialog = true;
          this.state.Dialog.dialogType = 'newpost';
          this.setState(this.state);
      },
      render: function(){
        
        var content = (<HelloPage />);
        if(this.state.Post.selectedPost != null){
          content = (
            <Post 
              id={this.state.Post.postId} 
              type="full" 
              data={this.state.Post.selectedPost} />
          );
        }
        return (
          <div>
            <Dialog show={this.state.Dialog.showDialog} type={this.state.Dialog.dialogType} />
            <paper-drawer-panel>
              <NavPanel posts={this.state.Post.posts} />
              <polymer-react main>
                <ContentPanel>
                  <paper-toolbar id="content-header" class="layout horizonal start-justified">
                    <span id="new-post" onClick={this.newPost}>New Post</span>
                  </paper-toolbar>
                  {content}
                </ContentPanel>
              </polymer-react>
            </paper-drawer-panel>
          </div>
        );
      }
    });

    var NavPanel = React.createClass({
      render: function(){
        var posts = this.props.posts.map(function(p,i){
          return (
            <Post id={i} key={i} data={p} type="list" />
          );
        });
        // use class rather than className for polymer elements
        return (
            <paper-scroll-header-panel drawer class="flex">
              <paper-toolbar id="post-header" class="layout horizontal">
                <div className="title">Posts</div>
              </paper-toolbar>
              {posts}
            </paper-scroll-header-panel>
        );
      },
    });

    var ContentPanel = React.createClass({
      render: function(){
        return (
          <div className="content">
           {this.props.children}
          </div>
        ); 
      },
    });

    var HelloPage = React.createClass({
      render: function(){
        return (
          <div class="layout vertical center">
            <h1>My React Blog</h1>
            <p>
              Welcome to my React blog. Where we discuss everything React and a few other things along the way.
            </p> 
          </div>
        );
      }
    });

    var Post = React.createClass({
      getInitialState: function(){
        return {comments:[]}
      },
      componentDidMount: function(){
        var _self = this;
        Store.addEventListener('change',function(e){
          var payload = e.detail;
          console.log('response in post ',payload.type,payload.aid);
          switch(payload.type){
            case 'post-comments':
              _self.setState({comments:payload.data});
              break;
            case 'comment-create':
              Dispatcher.dispatch({
                actionType: 'get-comment',
                commentId: payload.data
              });
              break;
            case 'comment-get':
              _self.state.comments.push(payload.data);
              _self.setState(this.state);
              break;
          }
        });
        console.log('post type ',this.props.type);
        
      },
      displayPost: function(){
        Dispatcher.dispatch({
            actionType: "a-show-post",
            postId: this.props.data.id
         }
        );
      },
      render: function(){
        if(this.props.type == "full"){
          var comments = this.state.comments.map(function(c){
            return (
              <blog-comment
                author={c.author}
                time={c.created_at}
                text={c.text} />
            );
          });
          var arg = {__html:this.props.data.text}
          var content = (
            <div dangerouslySetInnerHTML={arg}  />
          );
          return (
            <post-listing post-title={this.props.data.title}>
              {content}
              <comment-section>
                {comments}
              </comment-section>
            </post-listing>
          );
        }else{
          return (
            <post-listing post-title={this.props.data.title} onClick={this.displayPost}>
              <div>{this.props.data.description}</div>
            </post-listing>
          );
        }
          
      }
    });

    var NewPost = React.createClass({
        create: function(){
          var payload = {
            title:this.refs.title.value,
            description:this.refs.description.value,
            content:this.refs.content.value
          };
          this.refs.npDialog.close();
          Dispatcher.dispatch({
            actionType:'new-post',
            postData: payload
          });  
        },
        render: function(){
        return (
          <paper-dialog 
              ref="npDialog"
              opened={this.props.show}
              modal="true"
              entry-animation="scale-up-animation"
              exit-animation="fade-out-animation">
            <paper-dialog-scrollable>
                <fieldset>
                   <legend>New Post</legend>
                   <paper-input 
                     ref="title"
                     floatingLabel
                     autoValidate
                     required
                     allowedPattern="/[a-zA-Z0-9]/"
                     errorMessage="Must be Alpha Numeric"
                     label="Post Title" />
                     <paper-input
                     ref="description"
                     autoValidate
                     required
                     allowedPattern="/[a-zA-Z0-9]/"
                     errorMessage="Must be Alpha Numeric"
                     multiple
                     label="Post Description" />
                     <paper-textarea
                     ref="content"
                     autoValidate
                     required
                     rows="8"
                     allowedPattern="/[a-zA-Z0-9]/"
                     errorMessage="Must be Alpha Numeric"
                     label="Post Content" />
                </fieldset>
            </paper-dialog-scrollable>
            <div className="buttons">
              <paper-button dialog-dismiss>Cancel</paper-button>
              <paper-button onClick={this.create}>Accept</paper-button>
            </div>
          </paper-dialog>
        );
      }
    });


    var Dialog = React.createClass({
      render: function(){
        if(this.props.show){
          var content;
          switch(this.props.dialogType){
            case 'newpost':
              return (
                <NewPost show={this.props.show} />
              );
              break;
            default:
              return (
                <NewPost show="false" />
              );
          }
        }else{
            return (<div className="hidden"></div>);
        }
      }
    });

    var Comment = React.createClass({
      render:function(){
        return (
          <blog-comment 
            author={this.props.author}
            time={this.props.time}
            text={this.props.text} />
        );
      }
    });

    var CommentSection = React.createClass({
      render: function(){
        <comment-section>
          {this.props.chidlren}
        </comment-section>
      }
    });


    var app = document.querySelector('#app');
    ReactDOM.render(
      React.createElement(
        Application,{}
      ),app
    );
      
  </script>
</body>
</html>