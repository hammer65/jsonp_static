<!DOCTYPE html>
<html>
<head>
  <title></title>
  <title>My Blog</title>

  <!--
  Style includes just static styles not state styles
  -->
  <style is="custom-style">
    paper-drawer-panel {
     --paper-drawer-panel-left-drawer-container: {
         background-color: #1E1E33; 
         padding-right:2px;
      };
   }
   #post-header{
     --paper-toolbar-background:#CCCCC4;
     --paper-toolbar-color: #000;
     --paper-toolbar-height:36px;
   }

   #content-header{
     --paper-toolbar-background:#FFF;
     --paper-toolbar-color: #595959;
   }

   #new-post{
      cursor:pointer;
   }

   .hidden{
      display:none;
   }

   .dialog{
      width:650px;
   }
  </style>

  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="components.html">
</head>
<body>
  <div id="app"></div> 
  <app-storage name="posts" id="posts" />


  <script type="text/javascript" src="bower_components/react/react.js"></script>
  <script type="text/javascript" src="bower_components/react/react-dom.js"></script>
  <script type="text/javascript" src="include/Emitter.js"></script>
  <script type="text/javascript" src="bower_components/babel/browser.min.js"></script>
  <script type="text/javascript" src="bower_components/flux/dist/Flux.min.js"></script>
  <script type="text/javascript" src="bower_components/react-router/dist/ReactRouter.min.js"></script>

  <script type="text/babel">

    var Dispatcher = new Flux.Dispatcher();
    Dispatcher.register(function(payload){
      console.log("actionType ", payload.actionType);
      switch(payload.actionType){
        case 'show-post':
          PostStore.get(payload.selectedPost);
          break;
        case 'get-all':
          PostStore.getAll();
          break;
        case 'new-post':
          PostStore.create(payload.postData);
          break;
      }
    });
    var Router = ReactRouter;
    var PostStore = document.querySelector('#posts');

    
    PostStore.create({
        title: "React and Polymer Together",
        description: "Learn to use Polymer and React together",
        content: "<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. " 
        +"Proin in aliquam felis. Sed pulvinar iaculis dui sed interdum. Vivamus "
        +"a mauris eget purus vulputate cursus quis at est. </p><p>Sed efficitur sodales "
        +"rutrum. Proin sed ipsum vitae dolor semper fermentum. Cras augue"
        +"libero, pretium quis commodo a, posuere eget sem. Curabitur sagittis "
        +"turpis vitae arcu varius convallis. </p><p>Praesent dolor eros, consectetur quis "
        +"dolor a, cursus ornare ex. Suspendisse non consequat urna. Nulla in purus "
        +"quis turpis facilisis commodo at non odio. Nunc at augue in leo facilisis "
        +"accumsan. Maecenas et magna sem.</p>"
      });
    PostStore.create({
        title: "Using Vulcanize",
        description: "Learn how to use Vlucanize to combine all your web component fiels.",
        content: "<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. " 
        +"Proin in aliquam felis. Sed pulvinar iaculis dui sed interdum. Vivamus "
        +"a mauris eget purus vulputate cursus quis at est. </p><p>Sed efficitur sodales "
        +"rutrum. Proin sed ipsum vitae dolor semper fermentum. Cras augue"
        +"libero, pretium quis commodo a, posuere eget sem. Curabitur sagittis "
        +"turpis vitae arcu varius convallis. </p><p>Praesent dolor eros, consectetur quis "
        +"dolor a, cursus ornare ex. Suspendisse non consequat urna. Nulla in purus "
        +"quis turpis facilisis commodo at non odio. Nunc at augue in leo facilisis "
        +"accumsan. Maecenas et magna sem.</p>"
      });

    var Application = React.createClass({
      getInitialState: function(){
        return {
          showDialog:false,
          dialogType:null,
          selectedPost:null,
          posts:[]
        }
      },
      componentDidMount: function(){
        PostStore.addEventListener('posts-change',this.handleChange);
        Dispatcher.dispatch({
          actionType: 'get-all'
        });
      },
      handleChange:function(e){
        var payload = e.detail;
        console.log(payload);
        switch(payload.type){
          case 'get':
            this.setState({
              selectedPost: payload.data,
              posts: this.state.posts
            });
            break;
          case 'all':
            this.setState({
              selectedPost: null,
              posts: payload.data
            });
          case 'create':
            this.setState({
              selectedPost: payload.data[payload.createdID],
              posts:payload.data
            });
        }
      },
      newPost: function(){
          var s = this.state;
          s.showDialog = true;
          s.dialogType = 'newpost';
          this.setState(s);
      },
      render: function(){
        
        var content = (<HelloPage />);
        if(this.state.selectedPost != null){
          content = (
            <Post id={this.state.selectedPost.id} type="full" data={this.state.selectedPost} />
          );
        }
        return (
          <div>
            <Dialog show={this.state.showDialog} type={this.state.dialogType} />
            <paper-drawer-panel>
              <NavPanel posts={this.state.posts} />
              <ContentPanel>
                <paper-toolbar id="content-header" class="layout horizonal start-justified">
                  <span id="new-post" onClick={this.newPost}>New Post</span>
                </paper-toolbar>
                {content}
              </ContentPanel>
            </paper-drawer-panel>
          </div>
        );
      }
    });

    var NavPanel = React.createClass({
      render: function(){
        var posts = this.props.posts.map(function(p,i){
          return (
            <Post id={i} key={i} data={p} type="list" />
          );
        });
        // use class rather than className for polymer elements
        return (
            <paper-header-panel drawer>
              <paper-toolbar id="post-header" class="layout horizontal">
                <div className="title">Posts</div>
              </paper-toolbar>
              {posts}
            </paper-header-panel>
        );
      },
    });

    var ContentPanel = React.createClass({
      render: function(){
        return (
          <paqper-header-panel main>
           {this.props.children}
          </paqper-header-panel>
        ); 
      },
    });

    var HelloPage = React.createClass({
      render: function(){
        return (
          <div className="layout vertical center">
            <h1>My React Blog</h1>
            <p>
              Welcome to my React blog. Where we discuss everything React and a few other things along the way.
            </p> 
          </div>
        );
      }
    });

    var Post = React.createClass({
      displayPost: function(){
        Dispatcher.dispatch({
            actionType: "show-post",
            selectedPost: this.props.data.id
         }
        );
      },
      render: function(){
        if(this.props.type == "full"){
          var comments = '';
          var arg = {__html:this.props.data.content}
          var content = (
              <div dangerouslySetInnerHTML={arg}  />
            );
          return (
            <post-listing post-title={this.props.data.title} onClick={this.displayPost}>
              {content}
              <comment-section>
                {comments}
              </comment-section>
            </post-listing>
          );
        }else{
          return (
            <post-listing post-title={this.props.data.title} onClick={this.displayPost}>
              <div>{this.props.data.description}</div>
            </post-listing>
          );
        }
          
      }
    });

    var NewPost = React.createClass({
        create: function(){
          var payload = {
            title:this.refs.title.value,
            description:this.refs.description.value,
            content:this.refs.content.value
          };
          this.refs.npDialog.close();
          Dispatcher.dispatch({
            actionType:'new-post',
            postData: payload
          });  
        },
        render: function(){
        return (
          <paper-dialog 
              ref="npDialog"
              opened={this.props.show}
              modal="true"
              entry-animation="scale-up-animation"
              exit-animation="fade-out-animation">
            <paper-dialog-scrollable>
                <fieldset>
                   <legend>New Post</legend>
                   <paper-input 
                     ref="title"
                     floatingLabel
                     autoValidate
                     required
                     allowedPattern="/[a-zA-Z0-9]/"
                     errorMessage="Must be Alpha Numeric"
                     label="Post Title" />
                     <paper-input
                     ref="description"
                     autoValidate
                     required
                     allowedPattern="/[a-zA-Z0-9]/"
                     errorMessage="Must be Alpha Numeric"
                     multiple
                     label="Post Description" />
                     <paper-textarea
                     ref="content"
                     autoValidate
                     required
                     rows="8"
                     allowedPattern="/[a-zA-Z0-9]/"
                     errorMessage="Must be Alpha Numeric"
                     label="Post Content" />
                </fieldset>
            </paper-dialog-scrollable>
            <div className="buttons">
              <paper-button dialog-dismiss>Cancel</paper-button>
              <paper-button onClick={this.create}>Accept</paper-button>
            </div>
          </paper-dialog>
        );
      }
    });


    var Dialog = React.createClass({
      render: function(){
        if(this.props.show){
          var content;
          switch(this.props.dialogType){
            case 'newpost':
              return (
                <NewPost show={this.props.show} />
              );
              break;
            default:
              return (
                <NewPost show="false" />
              );
          }
        }else{
            return (<div className="hidden"></div>);
        }
      }
    });

    var Comment = react.createClass({
      render:function(){
        return (
          <blog-comment 
            author={this.props.author}
            time={this.props.time}
            text={this.props.text} />
        );
      }
    });

    var CommentSection = react.createClass({
      render: function(){
        <comment-section>
          {this.props.chidlren}
        </comment-section>
      }
    });


    var app = document.querySelector('#app');
    ReactDOM.render(
      React.createElement(
        Application,{posts:PostStore.getAll()}
      ),app
    );
      
  </script>
</body>
</html>